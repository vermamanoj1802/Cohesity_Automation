# Archive Directory

This directory contains scripts and configuration files related to Cohesity automation for archival tasks.

## Contents

- **archiveOldSnapshots.py**
  
  Python script for archiving old Cohesity snapshots.

- **archive_failed_jobs.yaml**
  
  YAML configuration related to archiving failed jobs.

- **joblist**
  
  File containing a list of jobs relevant to archiving processes.

- **pyhesity.py**
  
    Python helper library for interacting with Cohesity APIs and performing automation tasks.

- **archivedSnapshots.py**
  
  Python script  to list all archival snapshots (including in progress).

- **list_archived_snapshots.yaml**

   YAML configuration to list archived snapshots.
  
- **README_archive.md**
  
  This README file.

## Purpose

The files in this directory facilitate automation for archiving Cohesity backup jobs and snapshots. They include scripts for archiving old snapshots, handling failed archive jobs, job list management, and integration helpers for the Cohesity platform.

| Playbook                | Purpose                                                                                                               | Github Action Workflow to Use |
|-------------------------|-----------------------------------------------------------------------------------------------------------------------|-----------------|
| `archive_failed_jobs.yaml`   | Re-run the Failed Archive jobs for all Protection groups for a defined period. It will also send the outpu in .txt format on provided email ID | `.github/workflows/archive_failed_jobs`|
|`list_archvied_snapshots.yaml` | List all the archival snapshots for the PGs (all or selective) including snapshots in queue or running | `.github/workflows/List_Archived_Snapshots.yml`


## Usage

- Refer to `pyhesity.py` for reusable API functions. (DO NOT EDIT This File)
- Use `archiveOldSnapshots.py` to automate snapshot archival. (DO NOT EDIT This File)
- Edit `archive_failed_jobs.yaml` to configure failure handling.
- Update `joblist` as needed to reflect active or archived jobs. (Not used in playbook by default)

## üß© How to Run the failed Archive job automation

Follow these simple steps to safely re-run the failed archive jobs.
##
## üß™ Steps to Re-Run the failed Archive job

1. **Go to** the **Actions** menu and run the **`archive_failed_jobs`** workflow.

2. **Enter the required inputs** as mentioned below (default values are pre-filled; modify them as needed):
<img width="420" height="795" alt="image" src="https://github.com/user-attachments/assets/3e171a02-2756-4d9b-bf67-6eeab9a02254" />

  - **Select the cluster to make changes:**  
     Select the correct cluster from the drop-down list.
  
   - **number of days back to look for snapshots to archive:**  
     Number of days back to look for snapshots to archive.

   - **External Target Name which holds archives:**  
     Specify the Exeternal Target (bucket) name. Check this from Cohesity cluster UI.

   - **Recipient email address for receiving the test/actual run output :**  
     Enter your email address. Leave the default value to send the report to the entire team.

   - **Set to `true` to actually commit changes (adds `-c` flag):**  
     Perform a test run with the default value **`False`** before committing any changes.
     Select the option from dropdown list.
     <img width="388" height="173" alt="image" src="https://github.com/user-attachments/assets/7b3f3612-e5bb-4943-a701-7603ec17ede8" />
   - **Set to 'true' to exclude log backups (adds -e flag):**  
     if do not wish to re-run the failed archive jobs for DB log backups, keep it to **`False`**.
     Select the option from dropdown list.


---

### Notes
- Always verify the settings before running the workflow in commit mode.
- Use test mode (`False`) to validate input parameters and review the email report prior to making permanent changes.

  ##

As per your requirement You can add more options from below list. Add the additional parameters in `archive_failed_jobs.yaml` before executing your workflow.
   ##
**Additional Parameters**
##

    -v, --vip: DNS or IP of the Cohesity cluster to connect to
    -u, --username: username to authenticate to Cohesity cluster
    -d, --domain: (optional) domain of username, defaults to local
    -i, --useApiKey: (optional) use API key for authentication
    -p, --password: (optional) password or API key
    -k, --keepfor: (optional) keep for X days in the archive
    -t, --target: name of the external target
    -n, --daysback: (optional) number of days back to look for snapshots to archive (default is 31)
    -j, --joblist: (optional) text file of job names to include (one per line) default is all jobs
    -x, --excludelist: (optional) text file of job names to exclude (one per line)
    -l, --localonly: (optional) only archive local jobs
    -r, --replicasonly: (optional) only archive replica jobs
    -e, --excludelogs: (optional) do not archive database log backups
    -c, --commit: (optional) perform archives (show only if omitted)
    -f, --outfolder: (optional) location of output log file (default is current directory)
    -s, --retentionstring: (optional) substring of job name containing retention days (repeat for multiple)
    -m, --onlymatches: (optional) only include jobs that match one of the retention strings
    -n, --newerthan: (optional) only archive snapshots that are newer than X days old
    -o, --olderthan: (optional) only archive snapshots that are older than X days old

## üß© How to Run list_archvied_snapshots.yaml automation
Follow these simple steps to safely re-run the failed archive jobs.
##
## üß™ Steps to list_archvied_snapshots 

1. **Go to** the **Actions** menu and run the **`List_Archived_Snapshots`** workflow.

2. **Enter the required inputs** as mentioned below (default values are pre-filled; modify them as needed):
<img width="328" height="522" alt="image" src="https://github.com/user-attachments/assets/ed00d5bf-ccb8-4a95-92be-274a7fb85aea" />


  - **Select the cluster to make changes:**  
     Select the correct cluster from the drop-down list.
  
   - **External Target Name which holds archives:**  
     Specify the Exeternal Target (bucket) name. Check this from Cohesity cluster UI.

   - **Recipient email address for receiving the test/actual run output :**  
     Enter your email address. Leave the default value to send the report to the entire team.

   - **Set to `true` to list snapshots for all PGs :**
     if selected False (default), Please provide the list of PGs for which you want to list the snapshot in `Archive/joblist` file.

> **Warning:**  
‚ö†Ô∏èThese codes are provided on a best effort basis created for specific infra and is not in any way officially supported or sanctioned by Cohesity. The code in this repository are provided as-is and the author accepts no liability for damages resulting from its use.
